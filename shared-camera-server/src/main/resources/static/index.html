<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Shared Camera (with WebSocket)</title>
<link rel="stylesheet" href="./lib/bootstrap/css/bootstrap.min.css" />
<link rel="stylesheet" href="./shared-camera.css" />
</head>
<body>
  <div class="container">
    <h2>Shared Camera (with WebSocket)</h2>
    <div class="form-horizontal">
      <div class="form-group">
        <label class="col-sm-2 control-label">Status</label>
        <div class="col-sm-10">
          <p id="status" class="form-control-static">idle</p>
        </div>
      </div>
      <div class="form-group">
        <label class="col-sm-2 control-label">My Camera</label>
        <div class="col-sm-10">
          <div class="checkbox">
            <label>
              <input id="myCmaeraEnableCheckbox" type="checkbox"> Enable
            </label>
          </div>
          <div class="form-inline">
            Transmission interval(ms)
            <select id="intervalSelect" class="form-control input-sm">
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="200">200</option>
              <option value="500">500</option>
              <option value="1000">1,000</option>
              <option value="2000">2,000</option>
              <option value="5000">5,000</option>
            </select>&nbsp;&nbsp;&nbsp;&nbsp;
            Quality
            <select id="quaritySelect" class="form-control input-sm">
              <option value="1.0">1.0</option>
              <option value="0.9">0.9</option>
              <option value="0.8" selected>0.8</option>
              <option value="0.7">0.7</option>
              <option value="0.6">0.6</option>
              <option value="0.5">0.5</option>
              <option value="0.4">0.4</option>
              <option value="0.3">0.3</option>
              <option value="0.2">0.2</option>
              <option value="0.1">0.1</option>
            </select>
          </div>
          <video id="myCamera"></video>
        </div>
      </div>
      <div class="form-group">
        <label class="col-sm-2 control-label">Cameras</label>
        <div id="cameras" class="col-sm-10">
        </div>
      </div>
    </div>
  </div>
  <script src="./lib/jquery.min.js"></script>
  <script src="./lib/bootstrap/js/bootstrap.min.js"></script>
  <script src="./shared-camera.js"></script>
  <script>
    $(function() {
      const URL = window.URL || window.webkitURL;
      const endpoint = 'ws://' + location.host + '/endpoint?' + window.location.hash;

      const $status = $('#status').text('Idle');

      const $myCmaeraEnableCheckbox = $('#myCmaeraEnableCheckbox');
      const $intervalSelect = $('#intervalSelect');
      const $quaritySelect = $('#quaritySelect');
      const $myCamera = $('#myCamera').hide();
      const myCamera = $myCamera.get(0);
      const $cameras = $('#cameras');

      const sharedCamera = new SharedCamera(
        endpoint,
        {
          open: function() {
            $status.text('Connected');
          },
          close: function(event) {
            console.log(event);
            $status.text('Disconnected');
          },
          message: function(id, data) {
            let $img = $cameras.find(`img[data-id="${id}"]`).first();

            if (data.size == 0) {
              // clear
              $img.remove();
              return;
            }

            if ($img.length == 0) {
              $img = $('<img>').appendTo($cameras).attr('data-id', id);
            }

            $img.attr('src', URL.createObjectURL(data));
          },
          onerror: function(event) {
            console.log(event);
            $status.text('Failed');
          }
        }
      );

      $myCmaeraEnableCheckbox.on('change', () => {
        if ($myCmaeraEnableCheckbox.prop('checked')) {
          $myCamera.show();

          sharedCamera.enableCamera(
            myCamera,
            {
              interval: parseInt($intervalSelect.val()),
              quality: parseFloat($quaritySelect.val()),
            },
            (error) => {
              console.log(error);
              alert('Could not enable camera');
              $myCmaeraEnableCheckbox.prop('checked', false);
              $myCamera.hide();
            });

        } else {
          $myCamera.hide();
          sharedCamera.disableCamera(myCamera);
        }
      });

      function changeTransferSetting() {
        sharedCamera.changeTransferSetting(
          {
            interval: parseInt($intervalSelect.val()),
            quality: parseFloat($quaritySelect.val()),
          });
      }

      $intervalSelect.on('change', changeTransferSetting);
      $quaritySelect.on('change', changeTransferSetting);

      sharedCamera.connect();

    });
  </script>
</body>
</html>